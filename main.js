document.addEventListener('DOMContentLoaded', function() {
    // Privacy Policy Content (dynamically injected)
    const privacyPolicyHTML = `
<h1>Politique de Confidentialité de réglo.fr</h1>
<p><em>Dernière mise à jour : 15 Juillet 2024</em></p>

<h2>1. Introduction</h2>
<p>Bienvenue sur réglo.fr. Nous nous engageons à protéger la vie privée de nos clients et utilisateurs. Cette politique de confidentialité explique comment nous collectons, utilisons, divulguons et protégeons vos informations personnelles lorsque vous visitez notre site web et utilisez nos services.</p>

<h2>2. Données Collectées</h2>
<p>Nous pouvons collecter plusieurs types d'informations vous concernant, notamment :</p>
<ul>
    <li><strong>Informations personnelles d'identification :</strong> Nom, prénom, adresse e-mail, adresse postale, numéro de téléphone lorsque vous créez un compte, passez une commande ou vous inscrivez à notre newsletter.</li>
    <li><strong>Informations de paiement :</strong> Lorsque vous effectuez un achat, les informations relatives à votre paiement (numéro de carte de crédit, informations de facturation) sont collectées et traitées par nos prestataires de services de paiement sécurisés. Nous ne stockons pas directement les informations complètes de votre carte de crédit sur nos serveurs.</li>
    <li><strong>Données d'utilisation :</strong> Informations sur la manière dont vous utilisez notre site web, telles que les pages visitées, les produits consultés, le temps passé sur le site, et les informations relatives à votre appareil et à votre connexion internet (adresse IP, type de navigateur).</li>
    <li><strong>Cookies et technologies similaires :</strong> Informations collectées via des cookies pour améliorer votre expérience utilisateur (voir section Cookies).</li>
</ul>

<h2>3. Comment Nous Utilisons Vos Données</h2>
<p>Vos données sont utilisées pour :</p>
<ul>
    <li>Traiter et gérer vos commandes, y compris l'expédition et la livraison.</li>
    <li>Fournir un support client et répondre à vos demandes.</li>
    <li>Vous envoyer notre newsletter et des offres promotionnelles, si vous y avez consenti.</li>
    <li>Améliorer notre site web, nos produits et nos services.</li>
    <li>Prévenir la fraude et assurer la sécurité de notre site.</li>
    <li>Respecter nos obligations légales et réglementaires.</li>
</ul>

<h2>4. Partage des Données</h2>
<p>Nous ne vendons, n'échangeons ni ne louons vos informations personnelles à des tiers à des fins commerciales.</p>
<p>Nous pouvons partager vos informations avec des prestataires de services tiers qui nous aident à exploiter notre site web et à fournir nos services, tels que :</p>
<ul>
    <li>Les processeurs de paiement pour sécuriser vos transactions.</li>
    <li>Les sociétés de transport pour la livraison de vos commandes.</li>
    <li>Les fournisseurs de services marketing pour l'envoi de newsletters (si vous y avez consenti).</li>
</ul>
<p>Ces tiers sont tenus de protéger vos informations et ne sont autorisés à les utiliser que dans le cadre des services qu'ils nous fournissent.</p>

<h2>5. Conservation des Données</h2>
<p>Nous conservons vos informations personnelles aussi longtemps que nécessaire pour atteindre les finalités pour lesquelles elles ont été collectées, y compris pour satisfaire à toute exigence légale, comptable ou en matière de reporting. La durée de conservation de vos données dépendra de la nature des données et des finalités du traitement.</p>

<h2>6. Sécurité des Données</h2>
<p>Nous mettons en œuvre des mesures de sécurité techniques et organisationnelles appropriées pour protéger vos informations personnelles contre l'accès non autorisé, la divulgation, l'altération ou la destruction. Cependant, aucune méthode de transmission sur Internet ou de stockage électronique n'est sûre à 100 %.</p>

<h2>7. Politique en matière de Cookies</h2>
<p>Notre site utilise des cookies pour améliorer votre expérience de navigation. Les cookies sont de petits fichiers texte stockés sur votre appareil. Ils nous aident à mémoriser vos préférences, à comprendre comment vous interagissez avec notre site et à vous proposer des publicités pertinentes. Vous pouvez configurer votre navigateur pour refuser tous les cookies ou pour vous alerter lorsque des cookies sont envoyés. Toutefois, certaines parties de notre site pourraient ne pas fonctionner correctement sans cookies.</p>

<h2>8. Vos Droits</h2>
<p>Conformément à la réglementation applicable (notamment le RGPD), vous disposez des droits suivants concernant vos données personnelles :</p>
<ul>
    <li><strong>Droit d'accès :</strong> Vous pouvez demander une copie des informations personnelles que nous détenons à votre sujet.</li>
    <li><strong>Droit de rectification :</strong> Vous pouvez demander la correction des informations inexactes ou incomplètes.</li>
    <li><strong>Droit à l'effacement ('droit à l'oubli') :</strong> Vous pouvez demander la suppression de vos données personnelles dans certaines circonstances.</li>
    <li><strong>Droit à la limitation du traitement :</strong> Vous pouvez demander de limiter la manière dont nous utilisons vos données.</li>
    <li><strong>Droit à la portabilité des données :</strong> Vous pouvez demander à recevoir vos données dans un format structuré et couramment utilisé.</li>
    <li><strong>Droit d'opposition :</strong> Vous pouvez vous opposer au traitement de vos données à des fins de marketing direct.</li>
</ul>
<p>Pour exercer ces droits, veuillez nous contacter aux coordonnées ci-dessous.</p>

<h2>Politique de Remboursement et Garantie Satisfait ou Remboursé</h2>
<p>Chez réglo.fr, nous sommes convaincus de la qualité de nos produits et nous souhaitons que vous soyez pleinement satisfait de votre achat. C'est pourquoi nous offrons une garantie "Satisfait ou Remboursé".</p>

<h3>Conditions de la Garantie :</h3>
<ul>
    <li><strong>Délai de Rétractation :</strong> Conformément à la législation en vigueur, vous disposez d'un délai de 14 jours calendaires à compter de la date de réception de votre commande pour exercer votre droit de rétractation sans avoir à justifier de motifs ni à payer de pénalités.</li>
    <li><strong>Demande de Retour :</strong> Pour initier un retour dans le cadre de la garantie "Satisfait ou Remboursé" ou du droit de rétractation, veuillez contacter notre service client à bonjour@reglo.fr en indiquant votre numéro de commande et le(s) produit(s) concerné(s).</li>
    <li><strong>État du Produit :</strong>
        <ul>
            <li>Pour les produits alimentaires (croquettes, friandises) : Pour être éligible à un remboursement dans le cadre de la garantie "Satisfait ou Remboursé" si votre animal n'apprécie pas le produit, le sac de croquettes ou l'emballage du produit ne doit pas avoir été utilisé à plus de 25%. Pour le droit de rétractation standard, le produit doit être non ouvert et dans son emballage d'origine scellé.</li>
            <li>Pour les autres articles non alimentaires : L'article doit être retourné non utilisé, dans son état d'origine, avec tous les emballages, étiquettes et accessoires d'origine.</li>
        </ul>
    </li>
    <li><strong>Frais de Retour :</strong> Les frais de retour sont à la charge du client, sauf en cas d'erreur de notre part (produit défectueux ou non conforme à la commande). Nous vous recommandons d'utiliser un service de suivi pour le retour.</li>
    <li><strong>Inspection et Remboursement :</strong> Une fois l'article retourné reçu et inspecté, nous vous enverrons un e-mail pour vous informer de l'approbation ou du rejet de votre demande de remboursement. Si approuvé, votre remboursement sera traité et un crédit sera automatiquement appliqué à votre mode de paiement original dans un délai de 7 à 10 jours ouvrables.</li>
    <li><strong>Exclusions :</strong> Les produits personnalisés ou les articles en promotion spéciale avec mention contraire peuvent ne pas être éligibles à cette garantie.</li>
</ul>
<p>Notre objectif est votre satisfaction. N'hésitez pas à nous contacter pour toute question relative à notre politique de remboursement.</p>

<h2>Autres Conditions Spécifiques</h2>
<h3>Propriété Intellectuelle :</h3>
<p>L'ensemble du contenu présent sur le site réglo.fr, incluant, de façon non limitative, les graphismes, images, textes, vidéos, animations, sons, logos, gifs et icônes ainsi que leur mise en forme sont la propriété exclusive de la société réglo à l'exception des marques, logos ou contenus appartenant à d'autres sociétés partenaires ou auteurs. Toute reproduction, distribution, modification, adaptation, retransmission ou publication, même partielle, de ces différents éléments est strictement interdite sans l'accord exprès par écrit de réglo.</p>

<h3>Limitation de Responsabilité :</h3>
<p>Les informations contenues sur ce site sont aussi précises que possible et le site remis à jour à différentes périodes de l'année, mais peut toutefois contenir des inexactitudes ou des omissions. Si vous constatez une lacune, erreur ou ce qui parait être un dysfonctionnement, merci de bien vouloir le signaler par email, à l’adresse bonjour@reglo.fr, en décrivant le problème de la manière la plus précise possible (page posant problème, type d’ordinateur et de navigateur utilisé, …).</p>
<p>Tout contenu téléchargé se fait aux risques et périls de l'utilisateur et sous sa seule responsabilité. En conséquence, réglo ne saurait être tenu responsable d'un quelconque dommage subi par l'ordinateur de l'utilisateur ou d'une quelconque perte de données consécutives au téléchargement.</p>
<p>Les liens hypertextes mis en place dans le cadre du présent site internet en direction d'autres ressources présentes sur le réseau Internet ne sauraient engager la responsabilité de réglo.</p>

<h3>Droit Applicable et Attribution de Juridiction :</h3>
<p>Les présentes conditions du site réglo.fr sont régies par les lois françaises et toute contestation ou litiges qui pourraient naître de l'interprétation ou de l'exécution de celles-ci seront de la compétence exclusive des tribunaux dont dépend le siège social de la société. La langue de référence, pour le règlement de contentieux éventuels, est le français.</p>

<h3>Modification des Conditions :</h3>
<p>réglo se réserve le droit de modifier, à tout moment et sans préavis, les présentes conditions d'utilisation afin de les adapter aux évolutions du site et/ou de son exploitation.</p>

<h2>9. Mises à Jour de la Politique de Confidentialité</h2>
<p>Nous pouvons mettre à jour cette politique de confidentialité de temps à autre. Toute modification sera publiée sur cette page avec une date de mise à jour révisée. Nous vous encourageons à consulter régulièrement cette page pour rester informé de nos pratiques en matière de confidentialité.</p>

<h2>10. Nous Contacter</h2>
<p>
    Email : bonjour@reglo.fr<br>
    Téléphone : 01 87 20 02 40<br>
    Adresse : 12 rue Blanche, 75009 Paris, France
</p>
    `;

    const privacyPolicyContainer = document.getElementById('privacy-policy-content');
    if (privacyPolicyContainer) {
        const closeButton = privacyPolicyContainer.querySelector('#close-privacy-policy');
        const policyTextWrapper = document.createElement('div');
        policyTextWrapper.innerHTML = privacyPolicyHTML;
        
        if (closeButton) {
            privacyPolicyContainer.insertBefore(policyTextWrapper, closeButton);
        } else { 
            privacyPolicyContainer.innerHTML = privacyPolicyHTML + '<button id="close-privacy-policy" class="btn btn-primary" style="margin-top: 20px;">Fermer</button>';
        }
    }

    // Mobile menu functionality
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    const mobileMenu = document.querySelector('.mobile-menu');
    const closeMobileMenuBtn = document.querySelector('.close-mobile-menu');
    const cartOverlay = document.querySelector('.cart-overlay'); // Used by both mobile menu and cart
    const cartSidebar = document.querySelector('.cart-sidebar'); // Needed to check its state

    if (mobileMenuBtn && mobileMenu && closeMobileMenuBtn && cartOverlay) {
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.add('active');
            cartOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        
        closeMobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.remove('active');
            // Only deactivate overlay and restore scroll if cart is also not active
            if (!cartSidebar || !cartSidebar.classList.contains('active')) {
                cartOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
        // cartOverlay click listener is already set up in cart.js and handles both
    }

    // Legal modals functionality
    const legalLinks = document.querySelectorAll('.legal-link');
    const legalModals = {
        terms: document.getElementById('terms-modal'),
        privacy: document.getElementById('privacy-modal'),
        refund: document.getElementById('refund-modal')
    };
    const legalModalCloseBtns = document.querySelectorAll('.legal-modal-close');
    
    legalLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const modalType = this.dataset.type;
            if (legalModals[modalType]) {
                legalModals[modalType].classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        });
    });
    
    legalModalCloseBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.legal-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });
    
    Object.values(legalModals).forEach(modal => {
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });

    // Checkout button functionality (redirect and Telegram notification)
    const checkoutBtn = document.querySelector('.checkout-btn');
    if (checkoutBtn) {
        checkoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            
            // Assumes 'cart' object is available globally from cart.js
            if (typeof cart === 'undefined' || cart.itemCount === 0) {
                alert('Votre panier est vide. Ajoutez des produits avant de passer commande.');
                return;
            }
            
            const orderData = {
                items: cart.items,
                total: cart.total,
                date: new Date().toLocaleString('fr-FR', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                }),
                orderId: 'CMD-' + Date.now().toString().slice(-6)
            };
            
            localStorage.setItem('currentOrder', JSON.stringify(orderData));
            
            try {
                const telegramSuccess = await sendOrderToTelegram(orderData);
                if (telegramSuccess) {
                    console.log('Telegram notification sent successfully');
                } else {
                    console.warn('Failed to send Telegram notification, proceeding anyway');
                }
                window.location.href = 'commande.html';
            } catch (error) {
                console.error('Checkout process failed:', error);
                alert('Une erreur est survenue lors du traitement de votre commande. Veuillez réessayer.');
            }
        });
    }

    // Telegram sending function
    async function sendOrderToTelegram(orderData) {
        // Simulate sending order data
        console.log("Simulating: Order data prepared for Telegram (Order ID: " + orderData.orderId + "). In a real app, this would be sent via a secure backend.");
        // In a real app, this function would make a backend call.
        // For simulation, we'll just resolve successfully.
        return Promise.resolve(true);
    }

    // Privacy Policy Link Functionality (for footer link)
    const privacyLinkFooter = document.getElementById('footer-privacy-link');
    // privacyPolicyPage, closePrivacyPolicyBtn, mainPageSections are already defined above
    const mainPageSections = document.querySelectorAll('.main-page-section, .navbar, .top-bar, .footer'); // Select all top-level sections

    if (privacyLinkFooter && privacyPolicyContainer && closePrivacyPolicyBtn && mainPageSections.length > 0) {
        privacyLinkFooter.href = 'javascript:void(0);';
        privacyLinkFooter.addEventListener('click', function(e) {
            e.preventDefault();
            mainPageSections.forEach(section => {
                section.style.display = 'none';
            });
            privacyPolicyContainer.style.display = 'block';
            privacyPolicyContainer.scrollTop = 0;
            window.scrollTo(0,0);
        });

        const actualCloseButton = privacyPolicyContainer.querySelector('#close-privacy-policy');
        if(actualCloseButton) {
            actualCloseButton.addEventListener('click', function() {
                privacyPolicyContainer.style.display = 'none';
                mainPageSections.forEach(section => {
                    section.style.display = ''; // Reset display to default (or original if stored)
                });
            });
        }
    }
    
    // CGV Link in footer (similar to privacy policy, assuming it uses a modal)
    const cgvLinkFooter = document.getElementById('footer-cgv-link');
    const termsModal = document.getElementById('terms-modal'); // Already used by other legal links

    if (cgvLinkFooter && termsModal) {
        cgvLinkFooter.href = 'javascript:void(0);';
        cgvLinkFooter.addEventListener('click', function(e){
            e.preventDefault();
            termsModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
    }


    // Scroll Progress Bar
    window.addEventListener('scroll', function() {
        const progressBar = document.getElementById('scroll-progress-bar');
        if (!progressBar) return;

        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;

        if (scrollHeight <= clientHeight) {
            progressBar.style.width = '0%';
            return;
        }
        const scrolled = (scrollTop / (scrollHeight - clientHeight)) * 100;
        progressBar.style.width = scrolled + '%';
    });

    // Personalized Greeting Message
    const greetingElement = document.getElementById('personalized-greeting');
    if (greetingElement) {
        let greeting = '';
        const currentHour = new Date().getHours();

        if (currentHour >= 5 && currentHour < 12) {
            greeting = 'Bonjour ! Prêt(e) à trouver les croquettes parfaites pour votre compagnon ?';
        } else if (currentHour >= 12 && currentHour < 18) {
            greeting = 'Bon après-midi ! Explorez nos solutions de nutrition pour chiens.';
        } else {
            greeting = 'Bonsoir ! Découvrez nos produits pour le bien-être de votre chien.';
        }

        if (localStorage.getItem('isReturningUserReglo')) {
            greeting = 'Bon retour parmi nous ! ' + greeting.charAt(0).toLowerCase() + greeting.slice(1);
        } else {
            localStorage.setItem('isReturningUserReglo', 'true');
        }

        greetingElement.textContent = greeting;
        greetingElement.style.display = 'block';
    }
});
